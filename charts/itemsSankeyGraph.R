# # For testing purposes only
# library(httr)
# library(ggplot2)
# library(tidyverse)
# library(shiny)
# library(networkD3)
# source("./db/items.R")
# df_player_match_stats <- read.csv("./db/playerMatchStats.csv")
# puuid_cwalina <- "zwlLeN31xQwaocZE1bEC_i4Y91Rr6-VDrwrkPCi2G-SX889BGKzpT3IdtxhhdxncCX9cMjTgnoekAA" 
# puuid_borycki <- "sGIXvsl6UBP_Xsn8GJuJONeVj6H5ScomqSMsNMC6dI-E6A3mRDu1aPZb83rzHw6-_ExYKI_8W2xDTA"
# puuid_jarosz <- "n_Qfzo6Yhpupwck98rbPTHI23QyxqF17iUwCkgz_6WApNw39aFp5bhbq93pFvLICoBGCviFqQvEQag"


f_items_sankey_graph  <-  function(player){

  if (player == "Cwalina") {
    player_puuid <- puuid_cwalina
  } else if (player == "Borycki") {
    player_puuid <- puuid_borycki
  } else if (player == "Jarosz") {
    player_puuid <- puuid_jarosz
  } else {
    stop("Error: Invalid player_puuid.")
  }

  data = df_player_match_stats

  myStats <- data %>% 
    filter(player_puuid == player_id, !is.na(mythic_item)) %>% 
    select(champion_name,mythic_item)

  GroupChampItemTemp <- left_join(myStats,champion_stats %>% select(name,type),join_by('champion_name'=='name'))
  GroupChampItem <- left_join(GroupChampItemTemp,mythic_items_id %>% select(item_id,item_name),join_by('mythic_item'=='item_id'))
  
  champ_type_link <- GroupChampItem %>%
    select(champion_name,type) %>% 
    group_by(champion_name,type) %>% 
    count()

  champ_item_link <-  GroupChampItem %>% 
    select(champion_name,item_name) %>% 
    group_by(champion_name,item_name) %>% 
    count()
  
  links <- data.frame(
    source=c(champ_type_link$type, champ_item_link$champion_name), 
    target=c(champ_type_link$champion_name, champ_item_link$item_name), 
    value=c(champ_type_link$n, champ_item_link$n)
  )
  
  nodesTemp <- left_join(data.frame(
    name=c(as.character(links$source), 
           as.character(links$target)) %>% unique()
  ),champion_stats %>% select(name,type),join_by('name'=='name')) %>%
    mutate(type = ifelse(is.na(type) & name %in% unique(champion_stats$type),
                         name,type)) 
  nodes <- left_join(nodesTemp,mythic_items_id %>% select(item_name,recomanded),join_by('name'=='item_name')) %>%
    mutate(type = ifelse(is.na(type),recomanded,type))
  
  # With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
  links$IDsource <- match(links$source, nodes$name)-1 
  links$IDtarget <- match(links$target, nodes$name)-1
  
  #kolejność kolorów ,posortować
  tekst0 <- left_join(data.frame(type = unique(nodes$type)),class2Color,join_by('type'=='class'))$clolr
  tekst1 <- paste(c("'",paste(tekst0,collapse = "', '"),"'"),collapse=  "")
  tekst2 <- paste(c('d3.scaleOrdinal( [',tekst1,']);'),collapse = "")
  
  # Make the Network
  p <- sankeyNetwork(Links = links, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=FALSE,NodeGroup = "type",
                     colourScale = JS(tekst2))
  return(p)
}


# f_items_sankey_graph("Cwalina")
